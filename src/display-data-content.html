<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Excel Viewer - Select and view Excel cell ranges directly in the browser.">
  <meta name="author" content="Your Name">
  <title>Excel Viewer</title>
  <link rel="stylesheet" href="style/display-data-conent.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>

<body>
  <div class="header-container">
    <h1>Excel Data Mapper
      <span>Data Selection From Target File</span>
    </h1>
  </div>
  <div class="buttons-container">
    <button id="backButton" class="back-button">
      <i class="fas fa-arrow-left"></i> Back
    </button>

    <button id="notesButton" class="notes-button">
      <i class="fas fa-pencil-alt"></i> Notes
    </button>
    <button id="optionsButton" class="options-button">
      <i class="fas fa-sliders-h"></i> Options
    </button>
    <button id="validateButton" class="validate-button">
      <i class="fas fa-check"></i> Validate selection
    </button>

    <button id="refreshButton" class="refresh-button">
      <i class="fas fa-sync-alt"></i> Refresh
    </button>

    <button id="continueButton" class="continue-button">
      <i class="fas fa-arrow-right"></i> Continue
    </button>
  </div>
  <div id="range-info">Selected range: None</div>
  <div id="excel-container"></div>
  <div class="popup">
    <div class="popup-content"></div>
  </div>

  <script>
    // Selection functionality
    let startCell = null, endCell = null;
    let json = [];
    let firstOriginalTableHTML = '';
    (async () => {
      const excelContainer = document.getElementById('excel-container');
      const rangeInfo = document.getElementById('range-info');

      try {
        const files = await window.electronAPI.getBothExcelFiles();

        if (!files || (!files.target && !files.target)) {
          excelContainer.innerHTML = '<div class="error">No Excel files loaded. Please go back and select files.</div>';
          return;
        }

        // Use source file if available, otherwise use target file
        let buffer;
        if (files.target) {
          buffer = files.target;
        } else if (files.target) {
          buffer = files.target;
        }

        // Convert array to Uint8Array if needed
        const uint8Array = Array.isArray(buffer) ? new Uint8Array(buffer) : buffer;

        // Read the workbook
        const workbook = XLSX.read(uint8Array, { type: 'array' });
        const sheetName = workbook.SheetNames[0];
        const sheet = workbook.Sheets[sheetName];
        json = XLSX.utils.sheet_to_json(sheet, { header: 1 });

        function getColumnLabel(index) {
          let label = '';
          while (index >= 0) {
            label = String.fromCharCode((index % 26) + 65) + label;
            index = Math.floor(index / 26) - 1;
          }
          return label;
        }

        function getCellCoords(cellAddress) {
          const match = cellAddress.match(/^([A-Z]+)(\d+)$/);
          return {
            col: match[1],
            row: parseInt(match[2], 10),
          };
        }

        // Build the table
        let table = '<table>';
        json.forEach((row, rowIndex) => {
          table += '<tr>';
          row.forEach((cell, colIndex) => {
            const colLabel = getColumnLabel(colIndex);
            const cellAddress = `${colLabel}${rowIndex + 1}`;
            table += `<td data-cell="${cellAddress}" data-row="${rowIndex + 1}" data-col-index="${colIndex}">${cell || ''}</td>`;
          });
          table += '</tr>';
        });
        table += '</table>';
        excelContainer.innerHTML = table;



        function highlightSelection(start, end) {
          const cells = document.querySelectorAll('td');
          cells.forEach(cell => cell.classList.remove('selected'));

          if (!start || !end) return;

          const startCoords = getCellCoords(start.dataset.cell);
          const endCoords = getCellCoords(end.dataset.cell);

          const minRow = Math.min(startCoords.row, endCoords.row);
          const maxRow = Math.max(startCoords.row, endCoords.row);

          const minCol = Math.min(+start.dataset.colIndex, +end.dataset.colIndex);
          const maxCol = Math.max(+start.dataset.colIndex, +end.dataset.colIndex);

          cells.forEach(cell => {
            const row = parseInt(cell.dataset.row, 10);
            const col = parseInt(cell.dataset.colIndex, 10);
            if (row >= minRow && row <= maxRow && col >= minCol && col <= maxCol) {
              cell.classList.add('selected');
            }
          });

          const colStart = getColumnLabel(minCol);
          const colEnd = getColumnLabel(maxCol);
          rangeInfo.textContent = `Selected range: ${colStart}${minRow}:${colEnd}${maxRow}`;
        }

        /*
         * Adding event listeners to table cells
        */
        const tds = document.querySelectorAll('td');
        tds.forEach(td => {
          td.addEventListener('mousedown', () => {
            startCell = td;
            endCell = null;
            highlightSelection(startCell, startCell);
          });

          td.addEventListener('mouseenter', (e) => {
            if (startCell && e.buttons === 1) {
              endCell = td;
              highlightSelection(startCell, endCell);
            }
          });

          td.addEventListener('mouseup', () => {
            if (startCell && endCell) {
              highlightSelection(startCell, endCell);
            }
          });
        });


        const validateButton = document.querySelector('.validate-button');
        validateButton.addEventListener('click', () => {
          if (!startCell || !endCell) {
            alert("Please select at least two cells.");
            return;
          }

          const startCoords = getCellCoords(startCell.dataset.cell);
          const endCoords = getCellCoords(endCell.dataset.cell);

          const minRow = Math.min(startCoords.row, endCoords.row);
          const maxRow = Math.max(startCoords.row, endCoords.row);
          const minCol = Math.min(+startCell.dataset.colIndex, +endCell.dataset.colIndex);
          const maxCol = Math.max(+startCell.dataset.colIndex, +endCell.dataset.colIndex);

          const totalCells = (maxRow - minRow + 1) * (maxCol - minCol + 1);

          if (totalCells < 2) {
            alert("Please select at least two cells.");
            return;
          }

          // Build new table from selected range
          let selectedTable = '<table>';
          for (let i = minRow - 1; i < maxRow; i++) {
            selectedTable += '<tr>';
            for (let j = minCol; j <= maxCol; j++) {
              const cellValue = json[i] && json[i][j] !== undefined ? json[i][j] : '';
              selectedTable += `<td>${cellValue}</td>`;
            }
            selectedTable += '</tr>';
          }
          selectedTable += '</table>';

          // Replace table with selected content
          document.getElementById('excel-container').innerHTML = selectedTable;

          // Optional: update range info
          const colStart = getColumnLabel(minCol);
          const colEnd = getColumnLabel(maxCol);
          document.getElementById('range-info').textContent = `Validated range: ${colStart}${minRow}:${colEnd}${maxRow}`;
        });

      } catch (error) {
        console.error('Error loading Excel file:', error);
        excelContainer.innerHTML = '<div class="error">Error loading Excel file. Please try again.</div>';
      }
    })();

    const notesButton = document.querySelector('.notes-button');
    const popupDevContent = document.querySelector('.popup-content')
    notesButton.addEventListener('click', () => {
      popupDevContent.innerHTML = '';
      document.querySelector('.popup').style.display = "flex";
      document.body.classList.add('modal-open');
      const title = document.createElement('h2');
      title.className = 'popup-title';
      title.textContent = "Instructions";
      popupDevContent.appendChild(title);

      const messageDiv = document.createElement('div');
      messageDiv.className = "message-content";
      popupDevContent.appendChild(messageDiv);

      const text_p1 = document.createElement('p');
      text_p1.className = 'p-tag';
      text_p1.textContent = "1- Select your table which contains data and make sure the first row of it is the table header."
      messageDiv.appendChild(text_p1);

      const text_p2 = document.createElement('p');
      text_p2.className = 'p-tag';
      text_p2.textContent = "2- Select which option of table data integration you want to perform:"
      messageDiv.appendChild(text_p2);

      const text_p3 = document.createElement('p');
      text_p3.className = 'p-tag';
      text_p3.textContent = "• Integration of the full table selected."
      messageDiv.appendChild(text_p3);

      const text_p4 = document.createElement('p');
      text_p4.className = 'p-tag';
      text_p4.textContent = "• Integration of a specific table rows."
      messageDiv.appendChild(text_p4);

      const text_p5 = document.createElement('p');
      text_p5.className = 'p-tag';
      text_p5.textContent = "3- Press 'Validate' button to confirm your selection."
      messageDiv.appendChild(text_p5);

      const closeBtn = document.createElement('button');
      closeBtn.className = 'closeBtn';
      closeBtn.textContent = 'Close';
      closeBtn.style.marginTop = "5%";
      popupDevContent.appendChild(closeBtn);
      closeBtn.addEventListener('click', () => {
        document.querySelector('.popup').style.display = "none";
        document.body.classList.remove('modal-open');
      })
    });

    const optionsButton = document.querySelector('.options-button');
    const radioText = ["Option 1 : Full selected table", "Option 2 : Specific rows from selected table"];
    optionsButton.addEventListener('click', () => {
      popupDevContent.innerHTML = '';
      document.querySelector('.popup').style.display = "flex";
      document.body.classList.add('modal-open');
      const title = document.createElement('h2');
      title.className = 'popup-title';
      title.textContent = "Data Integration options";
      title.style.marginBottom = '40px';
      popupDevContent.appendChild(title);

      for (let j = 0; j < radioText.length; j++) {
        const radioDiv = document.createElement('div');
        radioDiv.className = 'radio';
        popupDevContent.appendChild(radioDiv);

        const input = document.createElement('input');
        input.type = 'radio'
        input.name = 'radio';
        input.className = 'radio-' + j;

        if (j == 0) {
          input.checked = true;
        } else {
          input.checked = false;
        }

        const label = document.createElement('label');
        label.setAttribute("for", "radio-" + j);
        label.className = 'radio-label';
        label.textContent = radioText[j];


        radioDiv.appendChild(input);
        radioDiv.appendChild(label);
      }

      const closeBtn = document.createElement('button');
      closeBtn.className = 'closeBtn';
      closeBtn.textContent = 'Close';
      closeBtn.style.marginTop = "20%";
      popupDevContent.appendChild(closeBtn);
      closeBtn.addEventListener('click', () => {
        document.querySelector('.popup').style.display = "none";
        document.body.classList.remove('modal-open');
      })
    })








  </script>
</body>

</html>